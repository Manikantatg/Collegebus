<!DOCTYPE html>
<html>
<head>
    <title>Initialize Database</title>
</head>
<body>
    <h1>Initializing Database...</h1>
    <pre id="output"></pre>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.0';
        
        const output = document.getElementById('output');
        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }
        
        const busRoutes = {
          1: [
            { name: "🌳 Kakarla Thota", scheduledTime: "7:40 AM" },
            { name: "🚧 Guggarati Railway Gate", scheduledTime: "7:43 AM" },
            { name: "🏪 APMC Main Gate", scheduledTime: "7:46 AM" },
            { name: "🕉️ Benki Mareamma Temple", scheduledTime: "7:50 AM" },
            { name: "👮 Bruce Pet Police Station", scheduledTime: "7:53 AM" },
            { name: "💎 Kalyan Jewellers", scheduledTime: "7:55 AM" },
            { name: "🔄 Mothi Circle", scheduledTime: "7:58 AM" },
            { name: "🎓 Mount View Campus", scheduledTime: "8:50 AM" }
          ],
          2: [
            { name: "🏫 RR Block", scheduledTime: "7:45 AM" },
            { name: "🎓 Mount View Campus", scheduledTime: "8:50 AM" }
          ]
        };
        
        const supabaseUrl = 'https://ijgrgqehmaqsznfavrhh.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqZ3JncWVobWFxc3puZmF2cmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODgyNDUsImV4cCI6MjA3NjE2NDI0NX0.scQupIqqFT6Js6Ak0ytpikq3vCDxlPoA-4QW9RTZ34E';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        async function initializeBuses() {
            log('Starting bus data initialization...');
            
            for (const busIdStr of Object.keys(busRoutes)) {
                const busId = parseInt(busIdStr);
                const route = busRoutes[busId];
                
                log(`Initializing Bus #${busId}...`);
                
                const { data: existingBus, error: busCheckError } = await supabase
                    .from('buses')
                    .select('id')
                    .eq('id', busId)
                    .maybeSingle();
                
                if (busCheckError) {
                    log(`Error checking bus ${busId}: ${busCheckError.message}`);
                    continue;
                }
                
                if (!existingBus) {
                    const { error: busError } = await supabase
                        .from('buses')
                        .insert({
                            id: busId,
                            current_stop_index: 0,
                            eta: null,
                            total_distance: 0
                        });
                    
                    if (busError) {
                        log(`Error creating bus ${busId}: ${busError.message}`);
                        continue;
                    }
                    log(`✓ Created bus ${busId}`);
                } else {
                    log(`✓ Bus ${busId} already exists`);
                }
                
                const { data: existingStops } = await supabase
                    .from('bus_stops')
                    .select('stop_index')
                    .eq('bus_id', busId);
                
                if (!existingStops || existingStops.length === 0) {
                    const stops = route.map((stop, index) => ({
                        bus_id: busId,
                        stop_index: index,
                        name: stop.name,
                        scheduled_time: stop.scheduledTime,
                        completed: false
                    }));
                    
                    const { error: stopsError } = await supabase
                        .from('bus_stops')
                        .insert(stops);
                    
                    if (stopsError) {
                        log(`Error creating stops for bus ${busId}: ${stopsError.message}`);
                        continue;
                    }
                    log(`✓ Created ${stops.length} stops for bus ${busId}`);
                } else {
                    log(`✓ Stops for bus ${busId} already exist`);
                }
            }
            
            log('Bus data initialization completed!');
        }
        
        initializeBuses().catch(err => log('Error: ' + err.message));
    </script>
</body>
</html>
